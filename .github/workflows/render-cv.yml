name: Render CV

on:
  push:
    branches: 
      - main
    paths: 
      - '**.yaml'
      - '**.yml'
      - '.github/workflows/render-cv.yml'
  pull_request:  
    branches: 
      - main
    paths: 
      - '**.yaml'
      - '**.yml'
  workflow_dispatch: 

permissions:
  contents: write
  pull-requests: write

jobs:  
  render:  
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cv_type: [detailed, compact]
    
    steps:  
      - name: Checkout repository
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0  # Fetch all history for versioning
      
      - name:  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version:  '3.12'
      
      - name:  Install RenderCV
        run: |
          pip install "rendercv[full]"
      
      - name: Get CV file name
        id: get-cv
        run: |
          # Find the CV YAML file based on matrix type
          CV_FILE=$(find . -maxdepth 1 -iname "*_CV_${{ matrix.cv_type }}.yaml" -o -iname "*_CV_${{ matrix.cv_type }}.yml" | head -n 1)
          
          if [ -z "$CV_FILE" ]; then
            echo "No ${{ matrix.cv_type }} CV file found!  Please name your file as Name_CV_${{ matrix.cv_type }}.yaml"
            exit 1
          fi
          
          echo "cv_file=$CV_FILE" >> $GITHUB_OUTPUT
          echo "Found ${{ matrix.cv_type }} CV file: $CV_FILE"
          
          # Extract base name without extension and path
          BASENAME=$(basename "$CV_FILE" .yaml)
          BASENAME=$(basename "$BASENAME" .yml)
          echo "basename=$BASENAME" >> $GITHUB_OUTPUT
      
      - name: Generate version number
        id: version
        run: |
          # Get current date
          DATE=$(date +%Y.%m.%d)
          
          # Get short commit SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Create version string
          VERSION="${DATE}-${SHORT_SHA}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION for ${{ matrix.cv_type }} CV"
      
      - name: Render CV
        run:  |
          rendercv render "${{ steps.get-cv.outputs.cv_file }}"
      
      - name:  Organize output files
        id: organize
        run: |
          # Find the output directory
          OUTPUT_DIR=$(find rendercv_output -maxdepth 1 -type d | tail -n 1)
          
          if [ -z "$OUTPUT_DIR" ]; then
            echo "Output directory not found!"
            exit 1
          fi
          
          echo "output_dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT
          
          # Find PDF file
          PDF_FILE=$(find "$OUTPUT_DIR" -name "*.pdf" | head -n 1)
          
          if [ -z "$PDF_FILE" ]; then
            echo "PDF file not found!"
            exit 1
          fi
          
          # Create release directory
          mkdir -p release-files
          
          # Copy PDF with descriptive name for release
          cp "$PDF_FILE" "release-files/Annurdien_Rasyid_CV_${{ matrix.cv_type }}.pdf"
          
          echo "pdf_file=Annurdien_Rasyid_CV_${{ matrix.cv_type }}.pdf" >> $GITHUB_OUTPUT
      
      - name: Upload CV for release
        uses:  actions/upload-artifact@v4
        with:
          name:  cv-${{ matrix.cv_type }}
          path: release-files/Annurdien_Rasyid_CV_${{ matrix.cv_type }}.pdf
          retention-days: 7

  create-release:
    runs-on: ubuntu-latest
    needs:  render
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download detailed CV
        uses: actions/download-artifact@v4
        with:
          name: cv-detailed
          path: release-files/
      
      - name: Download compact CV
        uses: actions/download-artifact@v4
        with:
          name: cv-compact
          path: release-files/
      
      - name: Generate version number
        id: version
        run: |
          DATE=$(date +%Y.%m.%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="${DATE}-${SHORT_SHA}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: CV Release ${{ steps.version.outputs.date }}
          files: |
            release-files/*.pdf
          body: |
            ## ðŸ“„ CV Release - ${{ steps.version.outputs.date }}
            
            **Generated CVs ready for download:**
            - ðŸ“˜ **Detailed CV** - Complete work history and comprehensive details
            - ðŸ“™ **Compact CV** - Condensed version optimized for quick review
            
            ---
            
            **Version Information:**
            - Date: ${{ steps.version.outputs.date }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            
            **Files included:**
            - `Annurdien_Rasyid_CV_detailed.pdf`
            - `Annurdien_Rasyid_CV_compact.pdf`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
