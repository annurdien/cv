name: Render CV

on:
  push:
    branches: 
      - main
    paths: 
      - '**. yaml'
      - '**.yml'
      - '. github/workflows/render-cv. yml'
  pull_request:  
    branches: 
      - main
    paths: 
      - '**.yaml'
      - '**.yml'
  workflow_dispatch: 

permissions:
  contents: write
  pull-requests: write

jobs:  
  render:  
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cv_type: [detailed, compact]
    
    steps:  
      - name: Checkout repository
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0  # Fetch all history for versioning
      
      - name:  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version:  '3.12'
      
      - name:  Install RenderCV
        run: |
          pip install "rendercv[full]"
      
      - name: Get CV file name
        id: get-cv
        run: |
          # Find the CV YAML file based on matrix type
          CV_FILE=$(find . -maxdepth 1 -iname "*_CV_${{ matrix.cv_type }}. yaml" -o -iname "*_CV_${{ matrix.cv_type }}. yml" | head -n 1)
          
          if [ -z "$CV_FILE" ]; then
            echo "No ${{ matrix.cv_type }} CV file found!  Please name your file as Name_CV_${{ matrix.cv_type }}.yaml"
            exit 1
          fi
          
          echo "cv_file=$CV_FILE" >> $GITHUB_OUTPUT
          echo "Found ${{ matrix.cv_type }} CV file: $CV_FILE"
          
          # Extract base name without extension and path
          BASENAME=$(basename "$CV_FILE" .yaml)
          BASENAME=$(basename "$BASENAME" . yml)
          echo "basename=$BASENAME" >> $GITHUB_OUTPUT
      
      - name: Generate version number
        id: version
        run: |
          # Get current date
          DATE=$(date +%Y.%m.%d)
          
          # Get short commit SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Create version string
          VERSION="${DATE}-${SHORT_SHA}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION for ${{ matrix.cv_type }} CV"
      
      - name: Render CV
        run:  |
          rendercv render "${{ steps.get-cv.outputs.cv_file }}"
      
      - name:  Organize output files
        id: organize
        run: |
          # Find the output directory
          OUTPUT_DIR=$(find rendercv_output -maxdepth 1 -type d | tail -n 1)
          
          if [ -z "$OUTPUT_DIR" ]; then
            echo "Output directory not found!"
            exit 1
          fi
          
          echo "output_dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT
          
          # Create versioned directory for this CV type
          mkdir -p cv_versions/${{ matrix.cv_type }}/${{ steps.version.outputs.version }}
          
          # Find PDF file
          PDF_FILE=$(find "$OUTPUT_DIR" -name "*.pdf" | head -n 1)
          
          if [ -z "$PDF_FILE" ]; then
            echo "PDF file not found!"
            exit 1
          fi
          
          BASENAME=$(basename "$PDF_FILE" .pdf)
          
          # Copy PDF with version in filename
          cp "$PDF_FILE" "cv_versions/${{ matrix.cv_type }}/${{ steps.version.outputs.version }}/${BASENAME}_${{ steps.version.outputs.version }}.pdf"
          
          # Also create a "latest" copy
          cp "$PDF_FILE" "cv_versions/${{ matrix. cv_type }}/${BASENAME}_latest.pdf"
          
          # Copy source file
          cp "${{ steps.get-cv.outputs. cv_file }}" "cv_versions/${{ matrix.cv_type }}/${{ steps.version.outputs.version }}/"
          
          echo "pdf_file=${BASENAME}_${{ steps.version.outputs.version }}.pdf" >> $GITHUB_OUTPUT
      
      - name: Upload CV as artifact
        uses:  actions/upload-artifact@v4
        with:
          name:  cv-${{ matrix.cv_type }}-${{ steps.version.outputs.version }}
          path: |
            cv_versions/${{ matrix.cv_type }}/${{ steps.version.outputs.version }}/
          retention-days: 90
      
      - name: Upload latest CV as artifact
        uses:  actions/upload-artifact@v4
        with:
          name:  cv-${{ matrix.cv_type }}-latest
          path: |
            cv_versions/${{ matrix. cv_type }}/*_latest.pdf
          retention-days: 365
      
      - name: Upload versioned files for commit
        uses: actions/upload-artifact@v4
        with: 
          name: commit-files-${{ matrix.cv_type }}
          path: cv_versions/${{ matrix.cv_type }}/
          retention-days: 1

  commit-versions:
    runs-on: ubuntu-latest
    needs: render
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download detailed CV files
        uses: actions/download-artifact@v4
        with: 
          name: commit-files-detailed
          path:  cv_versions/detailed/
      
      - name: Download compact CV files
        uses: actions/download-artifact@v4
        with:
          name: commit-files-compact
          path: cv_versions/compact/
      
      - name: Commit versioned CVs
        run: |
          git config --local user.email "github-actions[bot]@users. noreply.github.com"
          git config --local user. name "github-actions[bot]"
          
          git add cv_versions/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            VERSION=$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
            git commit -m "ðŸ¤– Auto-generate CVs version $VERSION"
            git push
          fi

  create-release:
    runs-on: ubuntu-latest
    needs:  render
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all CV artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cv-*-latest
          path: release-files/
      
      - name:  Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-files/**/*.pdf
          body: |
            ## CV Release ${{ github.ref_name }}
            
            This release includes both detailed and compact versions of the CV.
            
            ðŸ“„ **Files included:**
            - Detailed CV
            - Compact CV
            
            Generated from commit: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
